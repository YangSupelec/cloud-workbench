# -*- mode: ruby -*-
# vi: set ft=ruby :

require 'pathname'
vagrant_base_dir = Pathname.new(__FILE__).parent.parent.parent.expand_path

COOKBOOKS_PATH = File.expand_path("#{vagrant_base_dir}/../berks-cookbooks")
CHEF_KEYS_DIR = vagrant_base_dir.to_s
SSH_USERNAME = "ubuntu"

# Import parent configs and pass local context (e.g. variables)
base_config = File.read "#{vagrant_base_dir}/Vagrantfile.base"
eval(base_config, binding)
aws_config = File.read "#{vagrant_base_dir}/aws/Vagrantfile.aws"
eval(aws_config, binding)

Vagrant.configure('2') do |config|
  # VM
  # Enable this if you want to use an attached terminal
  # config.ssh.pty = true

  # AWS
  config.vm.provider :aws do |aws, override|
    aws.tags = {
        'Name' => 'WorkBench-Server-Staging'
    }
  end

  # Chef solo provisioning via vagrant-berkshelf plugin
  config.vm.provision :chef_solo, id: 'chef_solo' do |chef|
    chef.json = CHEF_JSON.deep_merge({
      "cloud-benchmarking-server" => {
          "apply_secret_config" => false,
          "delayed_job" => {
              "worker_processes" => "2"
          },
      },
    })
  end
end
